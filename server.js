// server.js
import fetch from "node-fetch";
import express from "express";
import cors from "cors";
import bodyParser from "body-parser";

const OPENAI_KEY = process.env.OPENAI_KEY;
const app = express();
app.use(cors());
app.use(bodyParser.json({ limit: "50mb" }));
app.use(bodyParser.urlencoded({ extended: true, limit: "50mb" }));

// =========================================================
//                      /analyze
// =========================================================
app.post("/analyze", async (req, res) => {
    try {
        console.log("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:", req.body);

        const { image } = req.body;
        if (!image) {
            return res.status(400).json({ error: "–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" });
        }

        console.log("üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ OpenAI...");

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${OPENAI_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é –±—ã—Ç–æ–≤—ã—Ö –æ—Ç—Ö–æ–¥–æ–≤ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–∞–≤–∏–ª–∞ –µ–≥–æ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å –¢–û–õ–¨–ö–û –ß–ò–°–¢–´–ô JSON.

‚ö†Ô∏è –û–ß–ï–ù–¨ –í–ê–ñ–ù–û:
–¢—ã –æ–ø–∏—Å—ã–≤–∞–µ—à—å –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ.  
–ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ, —Ç—ã –ù–ï –∏–º–µ–µ—à—å –ø—Ä–∞–≤–∞ —ç—Ç–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å.

-------------------------------------------
–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û):

{
 "item": "...",
 "material": "...",
 "container": "...",
 "instructions": [
    "—à–∞–≥ 1",
    "—à–∞–≥ 2",
    "—à–∞–≥ 3"
 ]
}
-------------------------------------------

1) –ü–æ–ª–µ "item":

–ü–æ–ª–µ "item" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é.

–ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —É–≤–µ—Ä–µ–Ω–Ω–æ ‚Äî —É–∫–∞–∂–∏ –µ–≥–æ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ  
(–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è –ø–æ–¥—Å—Ç–∞–≤–∫–∞", "–ª–µ–¥–µ–Ω–µ—Ü –≤ –æ–±—ë—Ä—Ç–∫–µ", "—Ä–µ–∑–∏–Ω–æ–≤–∞—è —É—Ç–æ—á–∫–∞").

–ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–µ–ø–æ–ª–Ω–∞—è ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–æ–π:
"–ü–æ—Ö–æ–∂–µ –Ω–∞: <–≤–∞—Ä–∏–∞–Ω—Ç>".

–ó–∞–ø—Ä–µ—â–µ–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º.
–ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–∏—Å–∞—Ç—å "–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å".
–ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–∏—Å–∞—Ç—å —á—Ç–æ-—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ ("–ø—Ä–µ–¥–º–µ—Ç", "–æ–±—ä–µ–∫—Ç").

2) –ü–û–õ–ï "material" (–º–∞—Ç–µ—Ä–∏–∞–ª –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –û–¢–•–û–î–ê):

–í—ã–±–∏—Ä–∞–π –æ–¥–∏–Ω –∏–∑:
- "–ø–ª–∞—Å—Ç–∏–∫"
- "–º–µ—Ç–∞–ª–ª"
- "—Å—Ç–µ–∫–ª–æ"
- "–±—É–º–∞–≥–∞/–∫–∞—Ä—Ç–æ–Ω"
- "–æ—Ä–≥–∞–Ω–∏–∫–∞"
- "–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª"

–ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –µ–¥–∞ –≤ —É–ø–∞–∫–æ–≤–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–µ–¥–µ–Ω–µ—Ü –≤ –ø–ª—ë–Ω–∫–µ, —à–æ–∫–æ–ª–∞–¥ –≤ –æ–±—ë—Ä—Ç–∫–µ):
- –º–∞—Ç–µ—Ä–∏–∞–ª **—É–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª —É–ø–∞–∫–æ–≤–∫–∏**, –∞ –Ω–µ –ø–∏—â–∏.

3) –ü–û–õ–ï "container" (–∫—É–¥–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å):

–î–û–õ–ñ–ï–ù –±—ã—Ç—å –°–¢–†–û–ì–û –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–æ–¥–∏–Ω —ç–º–æ–¥–∑–∏, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–µ–∫—Å—Ç–∞!):

- "üü° –∂—ë–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
- "üîµ —Å–∏–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
- "üü¢ –∑–µ–ª—ë–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
- "‚ö™ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
- "‚ö´ –Ω–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –æ—Ç—Ö–æ–¥—ã"

–ù–µ–ª—å–∑—è:
- –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Ç–æ—Ä–æ–π —ç–º–æ–¥–∑–∏,
- –º–µ–Ω—è—Ç—å —Å–ª–æ–≤–∞,
- –ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏, –¥–µ—Ñ–∏—Å—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.

4) –ü–û–õ–ï "instructions" (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏):

- –º–∞—Å—Å–∏–≤ –∏–∑ 3‚Äì5 –ø—É–Ω–∫—Ç–æ–≤;
- –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ –≤—ã–±—Ä–æ—Å—É;
- –ù–ï–õ–¨–ó–Ø –ø–∏—Å–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é (¬´—Å—ä–µ—Å—Ç—å¬ª, ¬´–ø–∏—Ç—å –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–º¬ª –∏ —Ç.–ø.);
- –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –æ—Å–Ω–æ–≤—ã–≤–∞—Ç—å—Å—è –¢–û–õ–¨–ö–û –Ω–∞ —Ç–æ–º, —á—Ç–æ –≤–∏–¥–Ω–æ.

–û–°–û–ë–û–ï –ü–†–ê–í–ò–õ–û –î–õ–Ø –ï–î–´ –í –£–ü–ê–ö–û–í–ö–ï:

–ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –µ–¥–∞ –≤ —É–ø–∞–∫–æ–≤–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–µ–¥–µ–Ω–µ—Ü –≤ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–π –ø–ª—ë–Ω–∫–µ):

- "item" –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å —ç—Ç–æ: –Ω–∞–ø—Ä–∏–º–µ—Ä "–õ–µ–¥–µ–Ω–µ—Ü –≤ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–π –æ–±—ë—Ä—Ç–∫–µ".
- "material" –∏ "container" –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –£–ü–ê–ö–û–í–ö–ï (–ø–ª—ë–Ω–∫–∞, –±—É–º–∞–≥–∞, –ø–ª–∞—Å—Ç–∏–∫ –∏ —Ç.–ø.).
- –í "instructions" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏:
  - —á—Ç–æ —Å—ä–µ–¥–æ–±–Ω—É—é —á–∞—Å—Ç—å –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å/—É—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ (–æ—Ä–≥–∞–Ω–∏–∫–∞/—Å–º–µ—Å—å),
  - —á—Ç–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–¥—ë—Ç –ò–ú–ï–ù–ù–û —É–ø–∞–∫–æ–≤–∫–∞, –Ω–µ —Å–∞–º–∞ –µ–¥–∞.

–ù–∞–ø—Ä–∏–º–µ—Ä:
"–°–Ω–∏–º–∏—Ç–µ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—É—é –æ–±—ë—Ä—Ç–∫—É —Å –ª–µ–¥–µ–Ω—Ü–∞."
"–°—ä–µ–¥–æ–±–Ω—É—é —á–∞—Å—Ç—å —É—Ç–∏–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∫—É –∏–ª–∏ –≤—ã–±—Ä–æ—Å—å—Ç–µ –≤ –æ–±—â–∏–π –º—É—Å–æ—Ä."
"–ü—É—Å—Ç—É—é —á–∏—Å—Ç—É—é –æ–±—ë—Ä—Ç–∫—É –≤—ã–±—Ä–æ—Å—å—Ç–µ –≤ –∂—ë–ª—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä."

5) –ñ–Å–°–¢–ö–ò–ï –ó–ê–ü–†–ï–¢–´:

- –ù–ï–õ–¨–ó–Ø –ø–∏—Å–∞—Ç—å, —á—Ç–æ –ø–∏—â—É –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏.
  –í —Ç–∞–∫–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–ª–∞–¥—ë—Ç—Å—è –¢–û–õ–¨–ö–û —É–ø–∞–∫–æ–≤–∫–∞.
- –ù–ï–õ–¨–ó–Ø —É–ø–æ–º–∏–Ω–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –≤–∏–¥–Ω–æ (–∫—Ä—ã—à–∫—É, —Ç—Ä—É–±–æ—á–∫—É, —ç—Ç–∏–∫–µ—Ç–∫—É),
  –µ—Å–ª–∏ –æ–Ω–∏ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –Ω–∞ —Ñ–æ—Ç–æ.
- –ù–ï–õ–¨–ó–Ø –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ, –∫—Ä–æ–º–µ JSON-–æ–±—ä–µ–∫—Ç–∞ –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞.
  –ù–∏ —Ç–µ–∫—Å—Ç–∞, –Ω–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –Ω–∏ Markdown, –Ω–∏ \`\`\`.
  
  –û–°–û–ë–û–ï –ü–†–ê–í–ò–õ–û:
–ï—Å–ª–∏ –Ω–∞ —Ñ–æ—Ç–æ –ø–∏—â–µ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç –≤ —É–ø–∞–∫–æ–≤–∫–µ (–ª–µ–¥–µ–Ω–µ—Ü –≤ –ø–ª—ë–Ω–∫–µ, —à–æ–∫–æ–ª–∞–¥, –ø–∏—Ä–æ–∂–æ–∫ –∏ —Ç.–¥.):

- item = "–õ–µ–¥–µ–Ω–µ—Ü –≤ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–π –æ–±—ë—Ä—Ç–∫–µ" (–∏–ª–∏ —Å –ø–æ–º–µ—Ç–∫–æ–π "–ü–æ—Ö–æ–∂–µ –Ω–∞...")
- material = –º–∞—Ç–µ—Ä–∏–∞–ª —É–ø–∞–∫–æ–≤–∫–∏
- container = –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏, –ù–ï –ø—Ä–æ–¥—É–∫—Ç–∞
- –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ–±—è–∑–∞–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

  "–û—Ç–¥–µ–ª–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É –æ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞."
  "–£–ø–∞–∫–æ–≤–∫—É –≤—ã–±—Ä–æ—Å—å—Ç–µ —Å–æ–≥–ª–∞—Å–Ω–æ –µ—ë –º–∞—Ç–µ—Ä–∏–∞–ª—É."
  "–°–∞–º –ø—Ä–æ–¥—É–∫—Ç —É—Ç–∏–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∫—É –∏–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç—Ö–æ–¥—ã."

                                `
                            },
                            { type: "image_url", image_url: { url: image } }
                        ]
                    }
                ]
            })
        });

        const data = await response.json();
        console.log("üìÑ –û—Ç–≤–µ—Ç OpenAI RAW:", data);

        let content = data.choices?.[0]?.message?.content;
        if (!content) {
            return res.json({ error: "OpenAI –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç" });
        }

        // –û—á–∏—â–∞–µ–º markdown
        content = content
            .replace(/```json/gi, "")
            .replace(/```/g, "")
            .trim();

        console.log("üì¶ –ß–∏—Å—Ç—ã–π JSON-—Ç–µ–∫—Å—Ç:", content);

        let parsed;
        try {
            parsed = JSON.parse(content);
            // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –ø–ª–æ—Ö–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç
            if (!parsed.item || parsed.item.trim() === "") {
            parsed.item = "–ü–æ—Ö–æ–∂–µ –Ω–∞: " + (parsed.material || "–±—ã—Ç–æ–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç");
            }

        } catch (err) {
            console.log("‚ùå –û—à–∏–±–∫–∞ JSON.parse:", err);
            return res.json({ error: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON", raw: content });
        }

        res.json(parsed);

    } catch (err) {
        console.error("üî• SERVER ERROR:", err);
        res.json({ error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
    }
});

// =========================================================
//           –†–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
// =========================================================
app.use(express.static("./"));

app.listen(3000, () =>
    console.log("üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: http://localhost:3000")
);
